<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oliday Quizz Pro - Multijoueur Live</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
      color: #00ffff;
      margin: 0;
      padding: 0;
    }
    .screen {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    h1, h2, h3 {
      text-align: center;
    }
    input, button {
      font-family: 'Orbitron', sans-serif;
    }
    .btn {
      padding: 10px 20px;
      background: #00ffff;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    .question-box {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #00ffff;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
    }
    .answer {
      margin: 5px 0;
      padding: 10px;
      background: #222;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .answer.correct {
      background-color: #00cc66;
    }
    .answer.wrong {
      background-color: #ff3333;
    }
    #qrPreview {
      max-width: 150px;
      margin-top: 10px;
      border: 2px solid #00ffff;
      border-radius: 8px;
    }
    .admin-panel {
      border-top: 2px solid #00ffff;
      margin-top: 30px;
      padding-top: 20px;
    }
  </style>
</head>
<body>
  <div class="screen">
    <h1>Oliday Quizz Pro - Multijoueur Live</h1>
    <input type="text" id="playerName" placeholder="Votre prénom..." />
    <button class="btn" onclick="joinGame()">Rejoindre</button>

    <div id="adminPanel" class="admin-panel" style="display:none">
      <h2>Panneau Administrateur</h2>
      <label>QR code personnalisé :
        <input type="file" id="qrUpload" accept="image/*" onchange="handleQRUpload(event)" />
        <img id="qrPreview" />
      </label><br/>
      <button class="btn" onclick="launchGame()">Lancer la partie</button>
    </div>

    <div id="qrDisplayArea" style="text-align:center; margin-top:20px;"></div>
    <div id="quizArea" style="display:none">
      <h2 id="quizTitle"></h2>
      <div id="questionContainer" class="question-box"></div>
      <div id="timerDisplay"></div>
    </div>

    <h3>Classement</h3>
    <ul id="leaderboard"></ul>
  </div>

  <script>
    const supabase = supabase.createClient("https://YOUR_PROJECT_URL.supabase.co", "YOUR_ANON_KEY");
    let isAdmin = false, name = "", score = 0, questionIndex = 0, timer;
    let currentQR = "", gameId = "oliday-quizz";

    async function joinGame() {
      name = document.getElementById("playerName").value.trim();
      if (!name) return alert("Entrez un prénom.");
      isAdmin = name.toLowerCase() === "admin";
      document.getElementById("adminPanel").style.display = isAdmin ? "block" : "none";
      const { data } = await supabase.from("config").select("*").eq("id", 1).single();
      if (data?.qr_url) {
        currentQR = data.qr_url;
        document.getElementById("qrDisplayArea").innerHTML = '<img src="' + currentQR + '" id="qrPreview" />';
      }
      if (!isAdmin) listenForStart();
      updateLeaderboard();
    }

    async function handleQRUpload(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async function(evt) {
        currentQR = evt.target.result;
        document.getElementById("qrPreview").src = currentQR;
        await supabase.from("config").upsert({ id: 1, qr_url: currentQR });
      };
      reader.readAsDataURL(file);
    }

    async function launchGame() {
      const theme = "Histoire";
      const questions = [
        { q: "Qui a fondé l'Empire romain ?", a: ["Jules César", "Auguste", "Néron", "Caligula"], r: 1 },
        { q: "Année de la Révolution française ?", a: ["1776", "1789", "1804", "1765"], r: 1 }
      ];
      await supabase.from("games").upsert({ id: gameId, started: true, questions });
    }

    async function listenForStart() {
      supabase.channel('game_start')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, async () => {
          const { data } = await supabase.from("games").select("*").eq("id", gameId).single();
          if (data?.started) startQuiz(data.questions);
        })
        .subscribe();
    }

    function startQuiz(questions) {
      questionIndex = 0;
      score = 0;
      document.getElementById("quizTitle").innerText = `Thème : Histoire`;
      document.getElementById("quizArea").style.display = "block";
      showQuestion(questions);
    }

    function showQuestion(questions) {
      clearTimeout(timer);
      if (questionIndex >= questions.length) return endQuiz();
      const q = questions[questionIndex];
      const container = document.getElementById("questionContainer");
      container.innerHTML = `<p>${q.q}</p>`;
      q.a.forEach((opt, i) => {
        const btn = document.createElement("div");
        btn.className = "answer";
        btn.innerText = opt;
        btn.onclick = () => handleAnswer(i, q);
        container.appendChild(btn);
      });
      startTimer(questions);
    }

    function startTimer(questions) {
      let time = 5;
      document.getElementById("timerDisplay").innerText = `Temps restant : ${time}s`;
      timer = setInterval(() => {
        time--;
        document.getElementById("timerDisplay").innerText = `Temps restant : ${time}s`;
        if (time <= 0) {
          clearInterval(timer);
          questionIndex++;
          showQuestion(questions);
        }
      }, 1000);
    }

    function handleAnswer(i, q) {
      clearInterval(timer);
      const answers = document.querySelectorAll(".answer");
      answers.forEach((el, idx) => {
        el.classList.add(idx === q.r ? "correct" : (idx === i ? "wrong" : ""));
      });
      if (i === q.r) score++;
      setTimeout(() => {
        questionIndex++;
        showQuestion([q]);
      }, 1000);
    }

    async function endQuiz() {
      document.getElementById("quizArea").innerHTML = `<h2>Fin du quiz ! Score : ${score}</h2>`;
      await supabase.from("players").insert([{ name, score }]);
      updateLeaderboard();
    }

    async function updateLeaderboard() {
      const { data } = await supabase.from("players").select("*").order("score", { ascending: false }).limit(10);
      const leaderboard = document.getElementById("leaderboard");
      leaderboard.innerHTML = data?.map(p => `<li>${p.name} - ${p.score} pts</li>`).join("") || "";
    }
  </script>
</body>
</html>
