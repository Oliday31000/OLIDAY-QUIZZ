<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oliday Quizz Pro - Multijoueur</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
      color: #00ffff;
      margin: 0;
      padding: 0;
    }
    .screen {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    h1, h2, h3 {
      text-align: center;
    }
    input, button {
      font-family: 'Orbitron', sans-serif;
    }
    .btn {
      padding: 10px 20px;
      background: #00ffff;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    .question-box {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #00ffff;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
    }
    .answer {
      margin: 5px 0;
      padding: 10px;
      background: #222;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .answer.correct {
      background-color: #00cc66;
    }
    .answer.wrong {
      background-color: #ff3333;
    }
    .admin-panel {
      border-top: 2px solid #00ffff;
      margin-top: 30px;
      padding-top: 20px;
    }
    #qrPreview {
      max-width: 150px;
      margin-top: 10px;
      border: 2px solid #00ffff;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="screen">
    <h1>Oliday Quizz Pro - Multijoueur</h1>
    <input type="text" id="playerName" placeholder="Votre prénom..." />
    <button class="btn" onclick="join()">Rejoindre</button>

    <div id="adminPanel" class="admin-panel" style="display:none">
      <h2>Panneau Administrateur</h2>
      <label>Nombre de joueurs :
        <input type="number" id="playerLimit" min="1" max="50" />
      </label><br/>
      <label>QR code personnalisé :
        <input type="file" id="qrUpload" accept="image/*" onchange="handleQRUpload(event)" />
        <img id="qrPreview" />
      </label><br/>
      <h3>Thèmes autorisés</h3>
      <div id="themes"></div>
      <button class="btn" onclick="saveConfig()">Sauvegarder la config</button>
    </div>

    <div id="quizArea" style="display:none">
      <h2 id="quizTitle"></h2>
      <div id="questionContainer" class="question-box"></div>
      <div id="timerDisplay"></div>
    </div>

    <h3>Classement</h3>
    <ul id="leaderboard"></ul>

    <div id="qrDisplayArea" style="text-align:center; margin-top:20px;"></div>
  </div>

  <script>
    const supabase = supabase.createClient("https://YOUR_PROJECT_URL.supabase.co", "YOUR_ANON_KEY");

    let isAdmin = false;
    let name = "";
    let currentQR = "";
    let score = 0;
    let questionIndex = 0;
    let selectedQuestions = [];
    let timer;

    const allThemes = ["Histoire", "Géographie", "Sciences", "Sport", "Cinéma", "Musique", "Littérature", "Technologie", "Nature", "Culture"];

    const questionsBank = {
      "Histoire": [
        { q: "Qui a fondé l'Empire romain ?", a: ["Jules César", "Auguste", "Néron", "Caligula"], r: 1 },
        { q: "En quelle année la Révolution française a-t-elle commencé ?", a: ["1776", "1789", "1804", "1765"], r: 1 }
      ],
      "Géographie": [
        { q: "Quel est le plus long fleuve du monde ?", a: ["Nil", "Amazone", "Yangtsé", "Mississippi"], r: 1 },
        { q: "Quelle est la capitale de l’Australie ?", a: ["Sydney", "Melbourne", "Canberra", "Brisbane"], r: 2 }
      ]
    };

    function join() {
      name = document.getElementById("playerName").value.trim();
      if (!name) return alert("Entrez un prénom.");
      isAdmin = name.toLowerCase() === "admin";
      document.getElementById("adminPanel").style.display = isAdmin ? "block" : "none";
      loadConfig();
      listenScores();
      if (!isAdmin) startQuiz();
    }

    async function loadConfig() {
      const { data } = await supabase.from("config").select("*").single();
      if (data) {
        document.getElementById("playerLimit").value = data.player_limit || 10;
        const container = document.getElementById("themes");
        container.innerHTML = "";
        allThemes.forEach(theme => {
          const input = document.createElement("input");
          input.type = "checkbox";
          input.id = "theme_" + theme;
          input.checked = data.theme_list?.includes(theme);
          container.appendChild(input);
          container.appendChild(document.createTextNode(" " + theme));
          container.appendChild(document.createElement("br"));
        });
        if (data.qr_url) {
          currentQR = data.qr_url;
          document.getElementById("qrPreview").src = currentQR;
          document.getElementById("qrDisplayArea").innerHTML =
            '<img src="' + currentQR + '" alt="QR Code" style="max-width:150px;border:2px solid #00ffff;border-radius:8px;" />';
        }
      }
    }

    async function saveConfig() {
      const player_limit = parseInt(document.getElementById("playerLimit").value);
      const selectedThemes = allThemes.filter(t => document.getElementById("theme_" + t).checked);
      await supabase.from("config").update({
        player_limit,
        theme_list: selectedThemes,
        qr_url: currentQR
      }).eq("id", 1);
      alert("Config enregistrée !");
    }

    function handleQRUpload(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        currentQR = e.target.result;
        document.getElementById("qrPreview").src = currentQR;
      };
      if (file) reader.readAsDataURL(file);
    }

    function startQuiz() {
      const theme = allThemes[Math.floor(Math.random() * allThemes.length)];
      selectedQuestions = questionsBank[theme].sort(() => 0.5 - Math.random()).slice(0, 5);
      questionIndex = 0;
      score = 0;
      document.getElementById("quizTitle").innerText = `Thème : ${theme}`;
      document.getElementById("quizArea").style.display = "block";
      showQuestion();
    }

    function showQuestion() {
      clearTimeout(timer);
      if (questionIndex >= selectedQuestions.length) return endQuiz();
      const q = selectedQuestions[questionIndex];
      const container = document.getElementById("questionContainer");
      container.innerHTML = `<p>${q.q}</p>`;
      q.a.forEach((opt, i) => {
        const btn = document.createElement("div");
        btn.className = "answer";
        btn.innerText = opt;
        btn.onclick = () => handleAnswer(i);
        container.appendChild(btn);
      });
      startTimer();
    }

    function startTimer() {
      let time = 5;
      document.getElementById("timerDisplay").innerText = `Temps restant : ${time}s`;
      timer = setInterval(() => {
        time--;
        document.getElementById("timerDisplay").innerText = `Temps restant : ${time}s`;
        if (time <= 0) {
          clearInterval(timer);
          questionIndex++;
          showQuestion();
        }
      }, 1000);
    }

    function handleAnswer(i) {
      clearInterval(timer);
      const q = selectedQuestions[questionIndex];
      const answers = document.querySelectorAll(".answer");
      answers.forEach((el, idx) => {
        el.classList.add(idx === q.r ? "correct" : (idx === i ? "wrong" : ""));
      });
      if (i === q.r) score++;
      setTimeout(() => {
        questionIndex++;
        showQuestion();
      }, 1000);
    }

    function endQuiz() {
      document.getElementById("quizArea").innerHTML = `<h2>Fin du quiz ! Score : ${score}</h2>`;
      supabase.from("players").insert([{ name, score }]);
    }

    function listenScores() {
      supabase.channel("players-channel")
        .on("postgres_changes", { event: "*", schema: "public", table: "players" }, payload => {
          updateLeaderboard();
        }).subscribe();
      updateLeaderboard();
    }

    async function updateLeaderboard() {
      const { data } = await supabase.from("players").select("*").order("score", { ascending: false }).limit(10);
      const leaderboard = document.getElementById("leaderboard");
      leaderboard.innerHTML = data?.map(p => `<li>${p.name} - ${p.score} pts</li>`).join("") || "";
    }
  </script>
</body>
</html>
