// Variables globales
let playerName = "";
let currentQuestion = 0;
let score = 0;
let correctAnswers = [];
let wrongAnswers = [];
let quizQuestions = [];
let currentTheme = "";
let timer;
let timeLeft = 5;

// Questions de base par th√®me (√† adapter si besoin)
const themes = {
  Histoire: [
    { q: "En quelle ann√©e la R√©volution fran√ßaise a-t-elle commenc√© ?", o: ["1789", "1812", "1848", "1765"], a: "1789" },
    { q: "Qui √©tait Napol√©on Bonaparte ?", o: ["Un roi", "Un empereur", "Un peintre", "Un philosophe"], a: "Un empereur" },
    { q: "Quel roi a √©t√© guillotin√© pendant la R√©volution ?", o: ["Louis XIV", "Louis XV", "Louis XVI", "Charles X"], a: "Louis XVI" },
    { q: "O√π est n√©e Jeanne d‚ÄôArc ?", o: ["Orl√©ans", "Rouen", "Domr√©my", "Reims"], a: "Domr√©my" },
    { q: "Quelle guerre a oppos√© la France √† l‚ÄôAllemagne en 1870 ?", o: ["Guerre de Cent Ans", "Premi√®re Guerre mondiale", "Guerre franco-prussienne", "Guerre de S√©cession"], a: "Guerre franco-prussienne" },
  ]
};

// Afficher une question
function showQuestion() {
  addReturnToMenu();
  applyThemeBackground(currentTheme);
  const container = document.getElementById("quizContainer");
  container.innerHTML = "";
  if (currentQuestion >= quizQuestions.length) {
    showResults();
    return;
  }
  const question = quizQuestions[currentQuestion];
  const questionHTML = `
    <div class='question-block'>
      <h2>Question ${currentQuestion + 1}</h2>
      <p>${question.q}</p>
      <button class='option-button' onclick='checkAnswer(0)'>${question.o[0]}</button>
      <button class='option-button' onclick='checkAnswer(1)'>${question.o[1]}</button>
      <button class='option-button' onclick='checkAnswer(2)'>${question.o[2]}</button>
      <button class='option-button' onclick='checkAnswer(3)'>${question.o[3]}</button>
    </div>`;
  container.innerHTML = questionHTML;
  startTimer();
}

// V√©rifier la r√©ponse
function checkAnswer(index) {
  clearInterval(timer);
  const question = quizQuestions[currentQuestion];
  const selectedAnswer = question.o[index];
  const isCorrect = selectedAnswer === question.a;
  if (isCorrect) {
    correctAnswers.push({ q: question.q, a: question.a });
    score++;
    playSound(true);
  } else {
    wrongAnswers.push({ q: question.q, a: question.a, w: selectedAnswer });
    playSound(false);
  }
  currentQuestion++;
  showQuestion();
}

// Sons bonnes/mauvaises r√©ponses
function playSound(correct) {
  const audio = new Audio(correct
    ? 'https://cdn.pixabay.com/audio/2022/03/15/audio_bfa6fa2045.mp3'
    : 'https://cdn.pixabay.com/audio/2022/03/15/audio_8ab2b07e36.mp3');
  audio.play();
}

// Timer 5s
function startTimer() {
  clearInterval(timer);
  timeLeft = 5;
  updateTimerDisplay();
  timer = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if (timeLeft <= 0) {
      clearInterval(timer);
      checkAnswer(-1);
    }
  }, 1000);
}

function updateTimerDisplay() {
  let timerDisplay = document.getElementById("timerDisplay");
  if (!timerDisplay) {
    timerDisplay = document.createElement("div");
    timerDisplay.id = "timerDisplay";
    timerDisplay.style.fontSize = "20px";
    timerDisplay.style.marginTop = "10px";
    document.getElementById("quizContainer").appendChild(timerDisplay);
  }
  timerDisplay.innerText = `Temps restant : ${timeLeft}s`;
}

// R√©sultats et score
function showResults() {
  saveScore();
  displayLeaderboard();
  const container = document.getElementById("resultContainer");
  container.innerHTML = `<h2>R√©sultats pour ${playerName}</h2>
    <p>Score : ${score}/${quizQuestions.length}</p>
    <h3>R√©ponses correctes :</h3>
    <ul>${correctAnswers.map(c => `<li><strong>${c.q}</strong><br>‚úîÔ∏è ${c.a}</li>`).join('')}</ul>
    <h3>R√©ponses incorrectes :</h3>
    <ul>${wrongAnswers.map(w => `<li><strong>${w.q}</strong><br>‚ùå R√©ponse : ${w.w}<br>‚úÖ Bonne : ${w.a}</li>`).join('')}</ul>
    <button onclick="location.reload()">Retour au menu</button>`;
  document.getElementById("quizContainer").style.display = "none";
  container.style.display = "block";
}

function saveScore() {
  const scores = JSON.parse(localStorage.getItem("quiz_scores") || "[]");
  scores.push({ name: playerName, score: score, total: quizQuestions.length });
  scores.sort((a, b) => b.score - a.score);
  localStorage.setItem("quiz_scores", JSON.stringify(scores.slice(0, 5)));
}

function displayLeaderboard() {
  const scoreboard = document.getElementById("scoreboard");
  const scores = JSON.parse(localStorage.getItem("quiz_scores") || "[]");
  scoreboard.innerHTML = `<h3>üèÜ Classement - Top 5</h3><ol>` +
    scores.map(s => `<li>${s.name} : ${s.score}/${s.total}</li>`).join('') +
    `</ol>`;
  scoreboard.style.display = "block";
}

function applyThemeBackground(theme) {
  const bg = localStorage.getItem(`bg_theme_${theme}`);
  if (bg) {
    document.body.style.backgroundImage = `url('${bg}')`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundRepeat = 'no-repeat';
    document.body.style.backgroundPosition = 'center';
    document.body.style.backgroundColor = 'black';
    document.body.style.backgroundBlendMode = 'overlay';
  } else {
    document.body.style.backgroundImage = "url('https://images.unsplash.com/photo-1606761568499-6c0e5390c13c?fit=crop&w=1400&q=80')";
  }
}

function addReturnToMenu() {
  const menuBtn = document.getElementById("returnBtn");
  if (!menuBtn) {
    const btn = document.createElement("button");
    btn.id = "returnBtn";
    btn.innerText = "Retour au menu";
    btn.style.marginTop = "20px";
    btn.onclick = () => location.reload();
    document.getElementById("quizContainer").appendChild(btn);
  }
}

// Zone admin
function showAdmin() {
  const adminDiv = document.createElement("div");
  adminDiv.innerHTML = `<h3>Mode Admin</h3>`;

  const resetBtn = document.createElement("button");
  resetBtn.innerText = "üîÑ R√©initialiser le classement";
  resetBtn.onclick = () => {
    if (confirm("Voulez-vous vraiment r√©initialiser les scores ?")) {
      localStorage.removeItem("quiz_scores");
      alert("Classement r√©initialis√©.");
      displayLeaderboard();
    }
  };
  adminDiv.appendChild(resetBtn);

  const themeBgControls = document.createElement("div");
  themeBgControls.innerHTML = `<h3>Changer les images de fond par th√®me</h3>`;
  Object.keys(themes).forEach(theme => {
    const label = document.createElement("label");
    label.style.display = "block";
    label.innerHTML = `${theme} : <input type='file' accept='image/jpeg' onchange='updateThemeBackground(event, "${theme}")'>`;
    themeBgControls.appendChild(label);
  });
  adminDiv.appendChild(themeBgControls);

  const quizBuilderBtn = document.createElement("button");
  quizBuilderBtn.innerText = "üé® Cr√©er un quiz personnalis√©";
  quizBuilderBtn.onclick = () => showCustomQuizBuilder();
  adminDiv.appendChild(quizBuilderBtn);

  document.getElementById("quizContainer").appendChild(adminDiv);
}

function updateThemeBackground(event, theme) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      localStorage.setItem(`bg_theme_${theme}`, e.target.result);
      alert(`Image pour '${theme}' mise √† jour.`);
    };
    reader.readAsDataURL(file);
  }
}

// Cr√©ation de quiz personnalis√©
function showCustomQuizBuilder() {
  const container = document.getElementById("quizContainer");
  container.innerHTML = "<h2>Cr√©er un quiz personnalis√©</h2>";

  const titleInput = document.createElement("input");
  titleInput.placeholder = "Titre du quiz";
  titleInput.id = "customTitle";
  container.appendChild(titleInput);

  const questionList = document.createElement("div");
  questionList.id = "customQuestions";
  container.appendChild(questionList);

  for (let i = 0; i < 10; i++) {
    const qBlock = document.createElement("div");
    qBlock.innerHTML = `
      <h4>Question ${i + 1}</h4>
      <input placeholder="Question" id="q${i}" /><br>
      <input placeholder="Option A" id="q${i}_0" />
      <input placeholder="Option B" id="q${i}_1" />
      <input placeholder="Option C" id="q${i}_2" />
      <input placeholder="Option D" id="q${i}_3" />
      <select id="q${i}_a">
        <option value="0">Bonne r√©ponse : A</option>
        <option value="1">Bonne r√©ponse : B</option>
        <option value="2">Bonne r√©ponse : C</option>
        <option value="3">Bonne r√©ponse : D</option>
      </select>
      <hr>`;
    questionList.appendChild(qBlock);
  }

  const launchBtn = document.createElement("button");
  launchBtn.innerText = "Lancer le quiz";
  launchBtn.onclick = () => {
    const newQuestions = [];
    for (let i = 0; i < 10; i++) {
      const q = document.getElementById(`q${i}`).value;
      const o0 = document.getElementById(`q${i}_0`).value;
      const o1 = document.getElementById(`q${i}_1`).value;
      const o2 = document.getElementById(`q${i}_2`).value;
      const o3 = document.getElementById(`q${i}_3`).value;
      const aIndex = parseInt(document.getElementById(`q${i}_a`).value);
      if (q && o0 && o1 && o2 && o3) {
        newQuestions.push({ q: q, o: [o0, o1, o2, o3], a: [o0, o1, o2, o3][aIndex] });
      }
    }
    if (newQuestions.length > 0) {
      quizQuestions = newQuestions.slice(0, 5); // 5 questions seulement
      currentQuestion = 0;
      score = 0;
      correctAnswers = [];
      wrongAnswers = [];
      showQuestion();
    } else {
      alert("Veuillez saisir au moins une question compl√®te.");
    }
  };
  container.appendChild(launchBtn);
}
